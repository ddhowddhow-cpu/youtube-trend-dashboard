<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate YouTube Trend Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {a
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            color: #212529;
        }
        .header {
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        .main-content {
            padding: 20px;
        }
        .video-card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .video-card:hover {
            transform: translateY(-5px);
        }
        .video-card img {
            width: 100%;
            height: auto;
        }
        .card-body {
            padding: 15px;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            height: 4.5em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        .stats-badge {
            font-size: 0.9em;
            font-weight: 700;
            padding: 5px 10px;
            margin-right: 5px;
            border-radius: 5px;
        }
        .badge-subscribers { background-color: #ff4500; color: white; }
        .badge-views { background-color: #008080; color: white; }
        .badge-likes { background-color: #ffd700; color: #212529; }
        .badge-comments { background-color: #6a5acd; color: white; }
        .category-button {
            border-radius: 20px;
            margin: 5px;
            font-weight: 700;
        }
        .category-button.active {
            color: #fff !important;
            background-color: #dc3545 !important;
        }
        .pill {
            font-size: 0.9rem;
        }
        .badge-time {
            font-size: 0.8rem;
            background-color: #e9ecef;
            color: #495057;
        }
    </style>
</head>
<body>

<div class="container-fluid header">
    <div class="row align-items-center">
        <div class="col-md-3 text-center">
            <h3>Ultimate YouTube Trend Dashboard</h3>
            <p class="text-muted">ìµœê·¼ 48ì‹œê°„ ê¸°ì¤€ ì¸ê¸° ì˜ìƒ ë¶„ì„</p>
        </div>
        <div class="col-md-6">
            <div class="input-group">
                <input id="searchInput" type="text" class="form-control" placeholder="ì œëª©/ì±„ë„ í‚¤ì›Œë“œ ê²€ìƒ‰">
                <button id="searchBtn" class="btn btn-primary">ê²€ìƒ‰</button>
            </div>
            <div class="mt-2">
                <span class="text-muted me-3">ì–¸ì–´ / ì§€ì—­ ì„ íƒ:</span>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="langKR" checked>
                    <label class="form-check-label" for="langKR">ğŸ‡°ğŸ‡· í•œêµ­</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="langEN">
                    <label class="form-check-label" for="langEN">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="langJP">
                    <label class="form-check-label" for="langJP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</label>
                </div>
            </div>
        </div>
        <div class="col-md-3 text-center">
            <p>API ì—°ë™ ìƒíƒœ: <span id="api-conn-badge" class="badge bg-secondary">í™•ì¸ ì¤‘...</span></p>
            <p class="text-muted">API í‚¤: <span class="badge bg-light text-dark">ë¸Œë¼ìš°ì € ì§í†µ í˜¸ì¶œ (í…ŒìŠ¤íŠ¸ìš©)</span></p>
        </div>
    </div>
    <hr>
    <div class="text-center">
        <button class="btn btn-outline-danger category-button active" data-category="All">ğŸ“Œ ì „ì²´ ì˜ìƒ</button>
        <button class="btn btn-outline-secondary category-button" data-category="Music">ğŸ¶ ìŒì•…/ëŒ„ìŠ¤</button>
        <button class="btn btn-outline-secondary category-button" data-category="Entertainment">ğŸ¬ ì½”ë¯¸ë””/ì˜¤ë½</button>
        <button class="btn btn-outline-secondary category-button" data-category="Sports">ğŸ€ ìŠ¤í¬ì¸ </button>
        <button class="btn btn-outline-secondary category-button" data-category="Vlog">ğŸ“¸ Vlog/ì¼ìƒ</button>
        <button class="btn btn-outline-secondary category-button" data-category="Education">ğŸ“š êµìœ¡/ì§€ì‹</button>
        <button class="btn btn-outline-secondary category-button" data-category="IT">ğŸ’» IT/í…Œí¬</button>
        <button class="btn btn-outline-secondary category-button" data-category="News">ğŸ“° ë‰´ìŠ¤/ì •ì¹˜</button>
    </div>
</div>

<div class="container main-content">
    <h4 id="category-title">ğŸ“Œ ì „ì²´ ì˜ìƒ</h4>
    <p class="text-muted" id="api-status">API í˜¸ì¶œ ì¤€ë¹„ ì¤‘...</p>
    <p class="text-muted" id="time-info">ê¸°ì¤€: ìµœê·¼ 48ì‹œê°„ ì´ë‚´ ì—…ë¡œë“œëœ ì¸ê¸° ì˜ìƒë§Œ í‘œì‹œ (ê°€ëŠ¥í•œ ê²½ìš°)</p>
    <div class="row" id="video-list"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // === YouTube Data API ì„¤ì • ===
    const API_KEY = 'AIzaSyDMYkSsjZzXOV0-OoCLclUAVT8VS93NlUQ'; // ğŸ‘‰ ì—¬ê¸° ë³¸ì¸ API í‚¤ë¡œ êµì²´
    const BASE_URL = 'https://www.googleapis.com/youtube/v3/';

    // ì¹´í…Œê³ ë¦¬ ë§¤í•‘
    const CATEGORIES = {
        'All': '',
        'Music': '10',
        'Entertainment': '24',
        'Sports': '17',
        'Vlog': '22',
        'Education': '27',
        'IT': '28',
        'News': '25'
    };

    let currentCategory = 'All';
    let currentVideosRaw = [];    // APIì—ì„œ ë°›ì€ ì›ë³¸
    let currentVideosFiltered = []; // 48ì‹œê°„ + ê²€ìƒ‰ í•„í„° í›„ ê²°ê³¼

    // ìˆ«ì í¬ë§· (K, M, B)
    function formatNumber(num) {
        if (num >= 1000000000) return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
        if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
        return num.toString();
    }

    // ì—…ë¡œë“œ ì‹œê°„ â†’ "ëª‡ ì‹œê°„ ì „" ìŠ¤íƒ€ì¼
    function timeAgo(publishedAt) {
        const now = new Date();
        const published = new Date(publishedAt);
        const diffMs = now - published;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffHours / 24);

        if (diffHours < 1) {
            const mins = Math.floor(diffMs / (1000 * 60));
            return `${mins}ë¶„ ì „`;
        } else if (diffHours < 24) {
            return `${diffHours}ì‹œê°„ ì „`;
        } else {
            return `${diffDays}ì¼ ì „`;
        }
    }

    // ì–¸ì–´/ì§€ì—­ ì„¤ì • ì½ê¸°
    function getRegionAndLanguage() {
        const kr = document.getElementById('langKR').checked;
        const en = document.getElementById('langEN').checked;
        const jp = document.getElementById('langJP').checked;

        // ìš°ì„ ìˆœìœ„: KR > US > JP
        if (kr) return { regionCode: 'KR', relevanceLanguage: 'ko' };
        if (en) return { regionCode: 'US', relevanceLanguage: 'en' };
        if (jp) return { regionCode: 'JP', relevanceLanguage: 'ja' };

        // ì•„ë¬´ê²ƒë„ ì•ˆ ê³ ë¥´ë©´ ê·¸ëƒ¥ ê¸°ë³¸ KR
        return { regionCode: 'KR', relevanceLanguage: 'ko' };
    }

    // ì¸ê¸° ë™ì˜ìƒ ê°€ì ¸ì˜¤ê¸° (mostPopular)
    async function fetchPopularVideos(categoryId) {
        const videoListDiv = document.getElementById('video-list');
        const apiStatusP = document.getElementById('api-status');
        const apiConnBadge = document.getElementById('api-conn-badge');

        videoListDiv.innerHTML = '';
        apiStatusP.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
        apiConnBadge.className = 'badge bg-warning text-dark';
        apiConnBadge.textContent = 'ìš”ì²­ ì¤‘...';

        const { regionCode } = getRegionAndLanguage();

        let url = `${BASE_URL}videos?part=snippet,contentDetails,statistics&chart=mostPopular&regionCode=${regionCode}&maxResults=50&key=${API_KEY}`;
        if (categoryId) {
            url += `&videoCategoryId=${categoryId}`;
        }

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (!data.items) {
                throw new Error(JSON.stringify(data));
            }

            currentVideosRaw = data.items;

            // ì±„ë„ êµ¬ë…ì ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
            const channelStatsMap = await fetchChannelStats(data.items);

            // 48ì‹œê°„ í•„í„° ì ìš©
            const now = new Date();
            const hours48Ago = new Date(now.getTime() - 48 * 60 * 60 * 1000);
            let within48 = data.items.filter(v => {
                const publishedAt = v.snippet.publishedAt;
                return new Date(publishedAt) >= hours48Ago;
            });

            // 48ì‹œê°„ ì•ˆì— ì•„ë¬´ ê²ƒë„ ì—†ìœ¼ë©´ ì „ì²´ ì‚¬ìš©
            if (within48.length === 0) {
                within48 = data.items;
                document.getElementById('time-info').textContent =
                    'âš ï¸ ì´ ì¹´í…Œê³ ë¦¬/ì§€ì—­ì—ì„œëŠ” ìµœê·¼ 48ì‹œê°„ ì—…ë¡œë“œ ì˜ìƒì´ ì ì–´ ì „ì²´ ì¸ê¸° ì˜ìƒ ëª©ë¡ì„ í‘œì‹œí•©ë‹ˆë‹¤.';
            } else {
                document.getElementById('time-info').textContent =
                    'ê¸°ì¤€: ìµœê·¼ 48ì‹œê°„ ì´ë‚´ ì—…ë¡œë“œëœ ì¸ê¸° ì˜ìƒë§Œ í‘œì‹œ ì¤‘ì…ë‹ˆë‹¤.';
            }

            currentVideosFiltered = within48;
            renderVideoList(within48, channelStatsMap);
            apiStatusP.textContent = `ì´ ${within48.length}ê°œì˜ ì˜ìƒì„ í‘œì‹œí•©ë‹ˆë‹¤.`;
            apiConnBadge.className = 'badge bg-success';
            apiConnBadge.textContent = 'API ì—°ê²° ì •ìƒ';
        } catch (error) {
            console.error('API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            apiStatusP.innerHTML =
                `âš ï¸ API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>API í‚¤($API_KEY$ë¥¼ ë³¸ì¸ì˜ í‚¤ë¡œ êµì²´í–ˆëŠ”ì§€)ì™€ ì¿¼í„°, ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.`;
            apiConnBadge.className = 'badge bg-danger';
            apiConnBadge.textContent = 'ì˜¤ë¥˜';
        }
    }

    // ì±„ë„ë³„ êµ¬ë…ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
    async function fetchChannelStats(videoItems) {
        const channelIds = Array.from(
            new Set(
                videoItems
                    .map(v => v.snippet.channelId)
                    .filter(Boolean)
            )
        );

        if (channelIds.length === 0) return {};

        // idëŠ” ìµœëŒ€ 50ê°œê¹Œì§€ ê°€ëŠ¥
        const url = `${BASE_URL}channels?part=statistics&id=${channelIds.join(',')}&key=${API_KEY}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            const map = {};
            if (data.items) {
                data.items.forEach(ch => {
                    const id = ch.id;
                    const subs = ch.statistics.subscriberCount
                        ? parseInt(ch.statistics.subscriberCount)
                        : 0;
                    map[id] = subs;
                });
            }
            return map;
        } catch (e) {
            console.error('ì±„ë„ ì •ë³´ í˜¸ì¶œ ì˜¤ë¥˜:', e);
            return {};
        }
    }

    // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderVideoList(videos, channelStatsMap = {}) {
        const videoListDiv = document.getElementById('video-list');
        videoListDiv.innerHTML = '';

        videos.forEach(video => {
            const cardHtml = createVideoCard(video, channelStatsMap);
            videoListDiv.innerHTML += cardHtml;
        });
    }

    // ì¹´ë“œ í•˜ë‚˜ ë§Œë“¤ê¸°
    function createVideoCard(video, channelStatsMap) {
        const title = video.snippet.title;
        const channelTitle = video.snippet.channelTitle;
        const channelId = video.snippet.channelId;
        const videoId = video.id;
        const thumbnailUrl = video.snippet.thumbnails.medium.url;
        const viewCount = video.statistics.viewCount ? parseInt(video.statistics.viewCount) : 0;
        const likeCount = video.statistics.likeCount ? parseInt(video.statistics.likeCount) : 0;
        const commentCount = video.statistics.commentCount ? parseInt(video.statistics.commentCount) : 0;
        const subscriberCount = channelStatsMap[channelId] || 0;
        const publishedAt = video.snippet.publishedAt;
        const timeAgoText = timeAgo(publishedAt);

        return `
            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                <div class="video-card">
                    <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank">
                        <img src="${thumbnailUrl}" class="card-img-top" alt="${title}">
                    </a>
                    <div class="card-body">
                        <h5 class="card-title">${title}</h5>
                        <p class="card-text text-muted mb-1">${channelTitle}</p>
                        <p class="card-text">
                            <span class="badge badge-time">${timeAgoText}</span>
                        </p>
                        <span class="stats-badge badge-views">${formatNumber(viewCount)} ì¡°íšŒ</span>
                        <span class="stats-badge badge-likes">${formatNumber(likeCount)} ì¢‹ì•„ìš”</span>
                        <span class="stats-badge badge-comments">${formatNumber(commentCount)} ëŒ“ê¸€</span>
                        <span class="stats-badge badge-subscribers">${formatNumber(subscriberCount)} êµ¬ë…</span>
                    </div>
                </div>
            </div>
        `;
    }

    // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    document.querySelectorAll('.category-button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelector('.category-button.active')?.classList.remove('active');
            this.classList.add('active');

            currentCategory = this.getAttribute('data-category');
            const categoryId = CATEGORIES[currentCategory];

            document.getElementById('category-title').textContent = this.textContent.trim();
            fetchPopularVideos(categoryId);
        });
    });

    // ì–¸ì–´ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ, í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë‹¤ì‹œ ë¡œë“œ
    ['langKR', 'langEN', 'langJP'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
            const categoryId = CATEGORIES[currentCategory];
            fetchPopularVideos(categoryId);
        });
    });

    // ê²€ìƒ‰ ê¸°ëŠ¥ (ì œëª©/ì±„ë„ëª… í¬í•¨)
    document.getElementById('searchBtn').addEventListener('click', () => {
        const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
        const apiStatusP = document.getElementById('api-status');

        if (!keyword) {
            // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ì›ë³¸ í•„í„° ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ í‘œì‹œ
            apiStatusP.textContent = `ì´ ${currentVideosFiltered.length}ê°œì˜ ì˜ìƒì„ í‘œì‹œí•©ë‹ˆë‹¤.`;
            renderVideoList(currentVideosFiltered);
            return;
        }

        const filtered = currentVideosFiltered.filter(v => {
            const title = v.snippet.title.toLowerCase();
            const channel = v.snippet.channelTitle.toLowerCase();
            return title.includes(keyword) || channel.includes(keyword);
        });

        apiStatusP.textContent = `ê²€ìƒ‰ ê²°ê³¼: ${filtered.length}ê°œ (í‚¤ì›Œë“œ: "${keyword}")`;
        renderVideoList(filtered);
    });

    // Enter í‚¤ë¡œ ê²€ìƒ‰
    document.getElementById('searchInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('searchBtn').click();
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« í˜¸ì¶œ
    document.addEventListener('DOMContentLoaded', () => {
        fetchPopularVideos(CATEGORIES[currentCategory]);
    });
</script>

</body>
</html>
