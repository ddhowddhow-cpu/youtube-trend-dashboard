<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ íˆ¬ë¸Œ ì‹¤ì‹œê°„ íŠ¸ë Œë“œ ì°¾ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            color: #212529;
        }
        .header {
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        .main-content {
            padding: 20px;
        }
        .video-card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .video-card:hover {
            transform: translateY(-5px);
        }
        .video-card img {
            width: 100%;
            height: auto;
        }
        .card-body {
            padding: 15px;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            height: 4.5em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        .stats-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 6px;
            margin-right: 3px;
            border-radius: 5px;
            display: inline-block;
        }
        .badge-subscribers { background-color: #ff4500; color: white; }
        .badge-views { background-color: #008080; color: white; }
        .badge-likes { background-color: #ffd700; color: #212529; }
        .badge-comments { background-color: #6a5acd; color: white; }
        .category-button {
            border-radius: 20px;
            margin: 5px;
            font-weight: 700;
        }
        .category-button.active {
            color: #fff !important;
            background-color: #dc3545 !important;
        }
        .badge-time {
            font-size: 0.8rem;
            background-color: #e9ecef;
            color: #495057;
        }
        .filter-bar {
            margin-top: 10px;
        }
        .filter-bar .btn-group + .btn-group {
            margin-left: 8px;
        }

        /* ì˜¤ë¥¸ìª½ íŠ¸ë Œë“œ í‚¤ì›Œë“œ ë°•ìŠ¤ */
        .trend-box {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 12px 14px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.06);
            max-height: 80vh;
            overflow-y: auto;
            font-size: 0.9rem;
        }
        .trend-box h5 {
            font-weight: 700;
        }
        .trend-meta {
            font-size: 0.75rem;
        }
        .trend-list {
            padding-left: 20px;
            margin-bottom: 0;
        }
        .trend-list li {
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .trend-keyword {
            flex: 1;
            margin-right: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .trend-score-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: #f1f3f5;
            color: #495057;
        }
    </style>
</head>
<body>

<div class="container-fluid header">
    <div class="row align-items-center">
        <div class="col-md-3 text-center">
            <h3>ìœ íˆ¬ë¸Œ íŠ¸ë Œë“œ ì°¾ê¸° ì œì‘:ìëˆ</h3>
            <p class="text-muted">ìµœê·¼ 48ì‹œê°„ ê¸°ì¤€ ì¸ê¸° ì˜ìƒ ë¶„ì„</p>
        </div>
        <div class="col-md-6">
            <div class="input-group">
                <input id="searchInput" type="text" class="form-control" placeholder="ì œëª©/ì±„ë„/í‚¤ì›Œë“œ ê²€ìƒ‰ (ì˜ˆ: í­ì‹¹)">
                <button id="searchBtn" class="btn btn-primary">ê²€ìƒ‰</button>
            </div>
            <div class="mt-2">
                <span class="text-muted me-3">ì–¸ì–´ / ì§€ì—­ ì„ íƒ:</span>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="langKR" checked>
                    <label class="form-check-label" for="langKR">ğŸ‡°ğŸ‡· í•œêµ­</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="langEN">
                    <label class="form-check-label" for="langEN">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="langJP">
                    <label class="form-check-label" for="langJP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</label>
                </div>
            </div>
        </div>
        <div class="col-md-3 text-center">
            <p>API ì—°ë™ ìƒíƒœ: <span id="api-conn-badge" class="badge bg-secondary">API í‚¤ ë¯¸ë“±ë¡</span></p>

            <div class="input-group input-group-sm mb-2">
                <input id="apiKeyInput" type="password" class="form-control" placeholder="ë³¸ì¸ YouTube API í‚¤ ì…ë ¥">
                <button id="saveApiKeyBtn" class="btn btn-outline-primary">ì €ì¥/ë³€ê²½</button>
                <button id="clearApiKeyBtn" class="btn btn-outline-danger">í•´ì œ</button>
            </div>
            <small id="apiKeyStatus" class="text-muted d-block">
                ì´ ë¸Œë¼ìš°ì €(PC/ë¸Œë¼ìš°ì €)ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
            </small>
        </div>
    </div>
    <hr>
    <div class="text-center">
        <button class="btn btn-outline-danger category-button active" data-category="All">ğŸ“Œ ì „ì²´ ì˜ìƒ</button>
        <button class="btn btn-outline-secondary category-button" data-category="Music">ğŸ¶ ìŒì•…/ëŒ„ìŠ¤</button>
        <button class="btn btn-outline-secondary category-button" data-category="Entertainment">ğŸ¬ ì½”ë¯¸ë””/ì˜¤ë½</button>
        <button class="btn btn-outline-secondary category-button" data-category="Sports">ğŸ€ ìŠ¤í¬ì¸ </button>
        <button class="btn btn-outline-secondary category-button" data-category="Vlog">ğŸ“¸ Vlog/ì¼ìƒ</button>
        <button class="btn btn-outline-secondary category-button" data-category="Education">ğŸ“š êµìœ¡/ì§€ì‹</button>
        <button class="btn btn-outline-secondary category-button" data-category="IT">ğŸ’» IT/í…Œí¬</button>
        <button class="btn btn-outline-secondary category-button" data-category="News">ğŸ“° ë‰´ìŠ¤/ì •ì¹˜</button>
    </div>

    <!-- ê¸¸ì´ + ì •ë ¬ í•„í„° -->
    <div class="text-center filter-bar">
        <div class="btn-group btn-group-sm" role="group" aria-label="Duration filter">
            <button class="btn btn-outline-dark duration-button active" data-duration="all">ì „ì²´ ê¸¸ì´</button>
            <button class="btn btn-outline-dark duration-button" data-duration="short">1ë¶„ ì´í•˜</button>
            <button class="btn btn-outline-dark duration-button" data-duration="long">1ë¶„ ì´ìƒ</button>
        </div>

        <div class="btn-group btn-group-sm" role="group" aria-label="View sort">
            <button class="btn btn-outline-secondary sort-button active" data-sort="viewsDesc">ì¡°íšŒìˆ˜ ë†’ì€ ìˆœ</button>
            <button class="btn btn-outline-secondary sort-button" data-sort="viewsAsc">ì¡°íšŒìˆ˜ ë‚®ì€ ìˆœ</button>
        </div>
    </div>

    <!-- êµ¬ë…ì ìˆ˜ í•„í„° -->
    <div class="text-center mt-2">
        <span class="text-muted me-2">êµ¬ë…ì ìˆ˜ í•„í„°:</span>

        <div class="form-check form-check-inline">
            <input class="form-check-input subscriber-filter-checkbox" type="checkbox"
                   id="subFilterAll" data-range="all" checked>
            <label class="form-check-label" for="subFilterAll">ì „ì²´</label>
        </div>

        <div class="form-check form-check-inline">
            <input class="form-check-input subscriber-filter-checkbox" type="checkbox"
                   id="subFilter1_1000" data-range="sub_1_1000">
            <label class="form-check-label" for="subFilter1_1000">1 ~ 1,000ëª…</label>
        </div>

        <div class="form-check form-check-inline">
            <input class="form-check-input subscriber-filter-checkbox" type="checkbox"
                   id="subFilter1000_10000" data-range="sub_1000_10000">
            <label class="form-check-label" for="subFilter1000_10000">1,000 ~ 1ë§Œëª…</label>
        </div>

        <div class="form-check form-check-inline">
            <input class="form-check-input subscriber-filter-checkbox" type="checkbox"
                   id="subFilter10000_40000" data-range="sub_10000_40000">
            <label class="form-check-label" for="subFilter10000_40000">1ë§Œ ~ 4ë§Œëª…</label>
        </div>

        <div class="form-check form-check-inline">
            <input class="form-check-input subscriber-filter-checkbox" type="checkbox"
                   id="subFilter50000_plus" data-range="sub_50000_plus">
            <label class="form-check-label" for="subFilter50000_plus">5ë§Œ ì´ìƒ</label>
        </div>
    </div>
</div>

<div class="container main-content">
    <div class="row">
        <!-- ì™¼ìª½: ì˜ìƒ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
        <div class="col-lg-9 col-md-8">
            <h4 id="category-title">ğŸ“Œ ì „ì²´ ì˜ìƒ</h4>
            <p class="text-muted" id="api-status">API í˜¸ì¶œ ì¤€ë¹„ ì¤‘...</p>
            <p class="text-muted" id="time-info">ê¸°ì¤€: ìµœê·¼ 48ì‹œê°„ ì´ë‚´ ì—…ë¡œë“œëœ ì¸ê¸° ì˜ìƒë§Œ í‘œì‹œ (ê°€ëŠ¥í•œ ê²½ìš°)</p>
            <div class="row" id="video-list"></div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: íŠ¸ë Œë“œ í‚¤ì›Œë“œ ì˜ì—­ -->
        <div class="col-lg-3 col-md-4">
            <div class="trend-box">
                <h5>ğŸ”¥ ì‹¤ì‹œê°„ íŠ¸ë Œë“œ í‚¤ì›Œë“œ TOP 30</h5>
                <p class="text-muted trend-meta mb-1" id="trend-region-info">
                    ì§€ì—­: KR ê¸°ì¤€
                </p>
                <p class="text-muted trend-meta mb-2" id="trend-updated-time">
                    ê¸°ì¤€: í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ì¸ê¸° ì˜ìƒ(ìµœê·¼ 48ì‹œê°„ ê¸°ì¤€)ì—ì„œ ìë™ ì¶”ì¶œ
                </p>
                <ol id="trend-keyword-list" class="trend-list">
                    <li><span class="trend-keyword">ë°ì´í„° ë¡œë”© ì¤‘...</span></li>
                </ol>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let API_KEY = null;
    const BASE_URL = 'https://www.googleapis.com/youtube/v3/';

    // ì¹´í…Œê³ ë¦¬ ID ë§¤í•‘
    const CATEGORIES = {
        'All': '',
        'Music': '10',
        'Entertainment': '24',
        'Sports': '17',
        'Vlog': '22',
        'Education': '27',
        'IT': '28',
        'News': '25'
    };

    // "ì „ì²´" íƒ­ì—ì„œ í•©ì¹  ì¹´í…Œê³ ë¦¬ ëª©ë¡
    const ALL_CATEGORY_IDS = ['10','24','17','22','27','28','25'];

    let currentCategory = 'All';
    let currentBaseVideos = [];      // 48ì‹œê°„ í•„í„°ê¹Œì§€ ì ìš©ëœ ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸
    let currentChannelStatsMap = {};
    let currentSearchKeyword = '';   // API ê²€ìƒ‰ì— ì‚¬ìš©ëœ í‚¤ì›Œë“œ (ì—†ìœ¼ë©´ íŠ¸ë Œë“œ ëª¨ë“œ)
    let currentDurationFilter = 'all';   // all | short | long
    let currentSortMode = 'viewsDesc';   // viewsDesc | viewsAsc
    let currentTrendKeywords = [];       // [{word, score}]
    // êµ¬ë…ì í•„í„°: ì„ íƒëœ êµ¬ê°„ë“¤ (ê¸°ë³¸ê°’: 'all')
    let currentSubscriberRanges = new Set(['all']);

    // ê³µí†µ/ì–¸ì–´ë³„ stopwords
    const STOPWORDS_COMMON = new Set([
        'official','video','music','mv','the','and','for','with','from','feat','live','of','in','on',
        'ë°©ì†¡','ì˜ìƒ','ê³µì‹','ì±„ë„','í‹°ë¹„','tv','full','ver','version','officialmv','shorts','ì‡¼ì¸ ',
        'ep','part','ì¬ì—…','í•˜ì´ë¼ì´íŠ¸','í’€ë²„ì „','í´ë¦½','clip','gameplay','highlight','ë‰´ìŠ¤','ë‹¨ë…'
    ]);
    const STOPWORDS_KO = new Set([
        'ì˜¤ëŠ˜','ì–´ì œ','ì´ë²ˆ','ì´ê²ƒ','ì €ê²ƒ','ìš°ë¦¬','ë‹¹ì‹ ','ì˜ìƒ','ì±„ë„','ê³µì‹','í•©ë‹ˆë‹¤','í•©ë‹ˆë‹¤ë§Œ',
        'í•©ë‹ˆë‹¤ìš”','ì…ë‹ˆë‹¤','ê·¸ëƒ¥','ì˜ìƒì…ë‹ˆë‹¤','ì˜ìƒë³´ê¸°'
    ]);
    const STOPWORDS_EN = new Set([
        'a','an','is','it','this','that','you','me','we','they','are','to','at','by','as','be','my','your',
        'our','their','new','official','feat','ft'
    ]);
    const STOPWORDS_JA = new Set([
        'ã®','ã«','ã‚’','ãŒ','ã¨','ã§','ã§ã™','ã¾ã™','ã™ã‚‹','ã—ãŸ','ã—ã¦','ã‹ã‚‰','ã¾ã§','ã•ã‚“','ã¡ã‚ƒã‚“',
        'ãã‚“','å…¬å¼','æ˜ åƒ'
    ]);

    // ìˆ«ì í¬ë§· (K, M, B)
    function formatNumber(num) {
        if (num >= 1000000000) return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
        if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
        return num.toString();
    }

    // ì—…ë¡œë“œ ì‹œê°„ â†’ "ëª‡ ì‹œê°„ ì „"
    function timeAgo(publishedAt) {
        const now = new Date();
        const published = new Date(publishedAt);
        const diffMs = now - published;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffHours / 24);

        if (diffHours < 1) {
            const mins = Math.floor(diffMs / (1000 * 60));
            return `${mins}ë¶„ ì „`;
        } else if (diffHours < 24) {
            return `${diffHours}ì‹œê°„ ì „`;
        } else {
            return `${diffDays}ì¼ ì „`;
        }
    }

    // ISO8601 duration â†’ ì´ˆ ë‹¨ìœ„
    function parseDurationSeconds(iso) {
        if (!iso) return 0;
        const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
        if (!match) return 0;
        const hours = parseInt(match[1] || '0');
        const minutes = parseInt(match[2] || '0');
        const seconds = parseInt(match[3] || '0');
        return hours * 3600 + minutes * 60 + seconds;
    }

    // ì–¸ì–´/ì§€ì—­ ì„¤ì •
    function getRegionAndLanguage() {
        const kr = document.getElementById('langKR').checked;
        const en = document.getElementById('langEN').checked;
        const jp = document.getElementById('langJP').checked;

        if (kr) return { regionCode: 'KR', relevanceLanguage: 'ko' };
        if (en) return { regionCode: 'US', relevanceLanguage: 'en' };
        if (jp) return { regionCode: 'JP', relevanceLanguage: 'ja' };
        return { regionCode: 'KR', relevanceLanguage: 'ko' };
    }

    // localStorageì—ì„œ API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadApiKey() {
        const savedKey = localStorage.getItem('ytTrendApiKey');
        const apiConnBadge = document.getElementById('api-conn-badge');
        const apiKeyStatus = document.getElementById('apiKeyStatus');
        const apiKeyInput = document.getElementById('apiKeyInput');

        if (savedKey) {
            API_KEY = savedKey;
            apiConnBadge.className = 'badge bg-success';
            apiConnBadge.textContent = 'API í‚¤ ë“±ë¡ë¨';
            apiKeyStatus.textContent = 'ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ë³¸ì¸ API í‚¤ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.';
            if (apiKeyInput) apiKeyInput.value = '';
        } else {
            API_KEY = null;
            apiConnBadge.className = 'badge bg-secondary';
            apiConnBadge.textContent = 'API í‚¤ ë¯¸ë“±ë¡';
            apiKeyStatus.textContent = 'ìƒë‹¨ ì…ë ¥ì°½ì— ë³¸ì¸ API í‚¤ë¥¼ ì €ì¥í•´ ì£¼ì„¸ìš”.';
        }
    }

    // API í‚¤ ì €ì¥
    function saveApiKey() {
        const apiKeyInput = document.getElementById('apiKeyInput');
        const newKey = apiKeyInput.value.trim();

        if (!newKey) {
            alert('API í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
        }

        localStorage.setItem('ytTrendApiKey', newKey);
        loadApiKey();
        alert('API í‚¤ê°€ ì €ì¥/ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.');
    }

    // API í‚¤ í•´ì œ
    function clearApiKey() {
        localStorage.removeItem('ytTrendApiKey');
        API_KEY = null;
        loadApiKey();
        document.getElementById('video-list').innerHTML = '';
        document.getElementById('api-status').textContent = 'API í‚¤ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‚¬ìš©í•˜ë ¤ë©´ API í‚¤ë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.';
        document.getElementById('trend-keyword-list').innerHTML = '<li><span class="trend-keyword">API í‚¤ë¥¼ ë¨¼ì € ë“±ë¡í•´ ì£¼ì„¸ìš”.</span></li>';
        alert('API í‚¤ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // íŠ¹ì • ì¹´í…Œê³ ë¦¬ì˜ mostPopular ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    async function fetchMostPopularForCategory(regionCode, categoryId) {
        let url = `${BASE_URL}videos?part=snippet,contentDetails,statistics&chart=mostPopular&regionCode=${regionCode}&maxResults=50&key=${API_KEY}`;
        if (categoryId) {
            url += `&videoCategoryId=${categoryId}`;
        }

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data.error) {
                console.error('YouTube API category error:', categoryId, data.error);
                return [];
            }
            return data.items || [];
        } catch (e) {
            console.error('fetchMostPopularForCategory fetch error:', categoryId, e);
            return [];
        }
    }

    // ì¸ê¸° ë™ì˜ìƒ (íŠ¸ë Œë“œ ëª¨ë“œ)
    async function fetchPopularVideos(categoryId) {
        const videoListDiv = document.getElementById('video-list');
        const apiStatusP = document.getElementById('api-status');
        const apiConnBadge = document.getElementById('api-conn-badge');

        if (!API_KEY) {
            videoListDiv.innerHTML = '';
            apiStatusP.textContent = 'ë¨¼ì € ìƒë‹¨ì—ì„œ ë³¸ì¸ YouTube API í‚¤ë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.';
            apiConnBadge.className = 'badge bg-secondary';
            apiConnBadge.textContent = 'API í‚¤ ë¯¸ë“±ë¡';
            return;
        }

        videoListDiv.innerHTML = '';
        apiStatusP.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
        apiConnBadge.className = 'badge bg-warning text-dark';
        apiConnBadge.textContent = 'ìš”ì²­ ì¤‘...';

        const { regionCode } = getRegionAndLanguage();
        updateTrendRegionInfo(); // ì˜¤ë¥¸ìª½ ë°•ìŠ¤ ì§€ì—­ í‘œì‹œ ì—…ë°ì´íŠ¸

        try {
            let allItems = [];

            if (!categoryId) {
                // ì „ì²´ íƒ­: ì—¬ëŸ¬ ì¹´í…Œê³ ë¦¬ì˜ ì¸ê¸° ì˜ìƒì„ ëª¨ë‘ í•©ì¹¨
                const promises = ALL_CATEGORY_IDS.map(id =>
                    fetchMostPopularForCategory(regionCode, id)
                );
                const results = await Promise.all(promises);
                results.forEach(arr => {
                    if (Array.isArray(arr)) allItems = allItems.concat(arr);
                });
            } else {
                // ê°œë³„ ì¹´í…Œê³ ë¦¬ íƒ­
                const arr = await fetchMostPopularForCategory(regionCode, categoryId);
                allItems = allItems.concat(arr);
            }

            if (allItems.length === 0) {
                currentBaseVideos = [];
                currentChannelStatsMap = {};
                renderVideoList([], {});
                updateTrendKeywords([]); // íŠ¸ë Œë“œ í‚¤ì›Œë“œ ì´ˆê¸°í™”
                apiStatusP.textContent = 'í‘œì‹œí•  ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤. (ì´ ì¹´í…Œê³ ë¦¬/ì§€ì—­ì—ì„œ ì¸ê¸° ì˜ìƒì´ ì—†ê±°ë‚˜ API ì¿¼í„° ì œí•œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)';
                document.getElementById('time-info').textContent =
                    'ê¸°ì¤€: ìµœê·¼ 48ì‹œê°„ ì´ë‚´ ì—…ë¡œë“œëœ ì¸ê¸° ì˜ìƒì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                apiConnBadge.className = 'badge bg-warning text-dark';
                apiConnBadge.textContent = 'ë°ì´í„° ì—†ìŒ';
                currentSearchKeyword = '';
                return;
            }

            // ì¤‘ë³µ ì œê±° (video.id ê¸°ì¤€)
            const uniqueMap = new Map();
            allItems.forEach(v => {
                const vid = v.id;
                if (!uniqueMap.has(vid)) {
                    uniqueMap.set(vid, v);
                }
            });
            let combinedItems = Array.from(uniqueMap.values());

            // ì¡°íšŒìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ê¸°ë³¸)
            combinedItems.sort((a, b) => {
                const va = parseInt(a.statistics?.viewCount || '0', 10);
                const vb = parseInt(b.statistics?.viewCount || '0', 10);
                return vb - va;
            });

            // 48ì‹œê°„ í•„í„°
            const now = new Date();
            const hours48Ago = new Date(now.getTime() - 48 * 60 * 60 * 1000);
            let within48 = combinedItems.filter(v => {
                const publishedAt = v.snippet.publishedAt;
                return new Date(publishedAt) >= hours48Ago;
            });

            if (within48.length === 0) {
                within48 = combinedItems;
                document.getElementById('time-info').textContent =
                    'âš ï¸ ì´ ì¹´í…Œê³ ë¦¬/ì§€ì—­ì—ì„œëŠ” ìµœê·¼ 48ì‹œê°„ ì—…ë¡œë“œ ì˜ìƒì´ ì ì–´ ì „ì²´ ì¸ê¸° ì˜ìƒ ëª©ë¡ì„ í‘œì‹œí•©ë‹ˆë‹¤.';
            } else {
                document.getElementById('time-info').textContent =
                    'ê¸°ì¤€: ìµœê·¼ 48ì‹œê°„ ì´ë‚´ ì—…ë¡œë“œëœ ì¸ê¸° ì˜ìƒë§Œ í‘œì‹œ ì¤‘ì…ë‹ˆë‹¤.';
            }

            currentBaseVideos = within48;
            currentSearchKeyword = ''; // íŠ¸ë Œë“œ ëª¨ë“œ
            const channelStatsMap = await fetchChannelStats(within48);
            currentChannelStatsMap = channelStatsMap;

            updateVideoListAndStatus();
            buildAndRenderTrendKeywords(); // ì—¬ê¸°ì„œ íŠ¸ë Œë“œ í‚¤ì›Œë“œ ìƒì„±+ë Œë”
            apiConnBadge.className = 'badge bg-success';
            apiConnBadge.textContent = 'API ì—°ê²° ì •ìƒ';
        } catch (error) {
            console.error('API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            apiStatusP.innerHTML =
                'âš ï¸ API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€, ì‚¬ìš© ì„¤ì •/ì¿¼í„°/ë¦¬í¼ëŸ¬(ë„ë©”ì¸) ì œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.';
            apiConnBadge.className = 'badge bg-danger';
            apiConnBadge.textContent = 'ì˜¤ë¥˜';
            updateTrendKeywords([]);
        }
    }

    // í‚¤ì›Œë“œ ê²€ìƒ‰ â€“ Search API + Videos API
    async function searchVideosByKeyword(keyword) {
        const videoListDiv = document.getElementById('video-list');
        const apiStatusP = document.getElementById('api-status');
        const apiConnBadge = document.getElementById('api-conn-badge');

        if (!API_KEY) {
            videoListDiv.innerHTML = '';
            apiStatusP.textContent = 'ë¨¼ì € ìƒë‹¨ì—ì„œ ë³¸ì¸ YouTube API í‚¤ë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.';
            apiConnBadge.className = 'badge bg-secondary';
            apiConnBadge.textContent = 'API í‚¤ ë¯¸ë“±ë¡';
            return;
        }

        videoListDiv.innerHTML = '';
        apiStatusP.textContent = `"${keyword}" ê²€ìƒ‰ ì¤‘...`;
        apiConnBadge.className = 'badge bg-warning text-dark';
        apiConnBadge.textContent = 'ê²€ìƒ‰ ì¤‘...';

        const { regionCode } = getRegionAndLanguage();
        updateTrendRegionInfo();

        try {
            const now = new Date();
            const hours48Ago = new Date(now.getTime() - 48 * 60 * 60 * 1000);
            const publishedAfter = hours48Ago.toISOString();

            const categoryId = CATEGORIES[currentCategory] || '';
            let searchBase =
                `${BASE_URL}search?part=snippet&type=video&maxResults=50&order=viewCount` +
                `&regionCode=${regionCode}&q=${encodeURIComponent(keyword)}&key=${API_KEY}`;
            if (categoryId) {
                searchBase += `&videoCategoryId=${categoryId}`;
            }

            // 1ì°¨: ìµœê·¼ 48ì‹œê°„ ì´ë‚´
            let searchUrl = `${searchBase}&publishedAfter=${publishedAfter}`;
            let response = await fetch(searchUrl);
            let searchData = await response.json();

            if (searchData.error) {
                console.error('search API error:', searchData.error);
                throw new Error('search API error');
            }

            let items = searchData.items || [];

            // 48ì‹œê°„ ë‚´ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ê¸°ê°„ ì œí•œ ì—†ì´ ë‹¤ì‹œ ì‹œë„
            if (items.length === 0) {
                searchUrl = searchBase;
                response = await fetch(searchUrl);
                searchData = await response.json();
                if (searchData.error) {
                    console.error('search API error (no date):', searchData.error);
                    throw new Error('search API error');
                }
                items = searchData.items || [];
            }

            if (items.length === 0) {
                currentBaseVideos = [];
                currentChannelStatsMap = {};
                renderVideoList([], {});
                updateTrendKeywords([]);
                apiStatusP.textContent = `"${keyword}" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                document.getElementById('time-info').textContent =
                    'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ.';
                apiConnBadge.className = 'badge bg-warning text-dark';
                apiConnBadge.textContent = 'ê²€ìƒ‰ 0ê°œ';
                currentSearchKeyword = keyword;
                return;
            }

            const videoIds = items
                .map(it => it.id && it.id.videoId)
                .filter(Boolean);

            const videosUrl =
                `${BASE_URL}videos?part=snippet,contentDetails,statistics&id=${videoIds.join(',')}&key=${API_KEY}`;
            const videosResp = await fetch(videosUrl);
            const videosData = await videosResp.json();

            if (videosData.error) {
                console.error('videos API error for search:', videosData.error);
                throw new Error('videos API error');
            }

            let videoItems = videosData.items || [];

            // ì¡°íšŒìˆ˜ ê¸°ì¤€ ì •ë ¬ (ê¸°ë³¸ ë‚´ë¦¼ì°¨ìˆœ)
            videoItems.sort((a, b) => {
                const va = parseInt(a.statistics?.viewCount || '0', 10);
                const vb = parseInt(b.statistics?.viewCount || '0', 10);
                return vb - va;
            });

            // 48ì‹œê°„ í•„í„°
            const hours48Ago2 = new Date(now.getTime() - 48 * 60 * 60 * 1000);
            let within48 = videoItems.filter(v => {
                const publishedAt = v.snippet.publishedAt;
                return new Date(publishedAt) >= hours48Ago2;
            });

            if (within48.length === 0) {
                within48 = videoItems;
                document.getElementById('time-info').textContent =
                    'âš ï¸ ì´ í‚¤ì›Œë“œì— ëŒ€í•´ ìµœê·¼ 48ì‹œê°„ ë‚´ ì—…ë¡œë“œëœ ì˜ìƒì´ ì ì–´ ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.';
            } else {
                document.getElementById('time-info').textContent =
                    'ê¸°ì¤€: ì´ í‚¤ì›Œë“œì— ëŒ€í•´ ìµœê·¼ 48ì‹œê°„ ì´ë‚´ ì—…ë¡œë“œëœ ì¸ê¸° ì˜ìƒë§Œ í‘œì‹œ ì¤‘ì…ë‹ˆë‹¤.';
            }

            currentBaseVideos = within48;
            currentSearchKeyword = keyword;

            const channelStatsMap = await fetchChannelStats(within48);
            currentChannelStatsMap = channelStatsMap;

            updateVideoListAndStatus();
            buildAndRenderTrendKeywords(); // ê²€ìƒ‰ ê²°ê³¼ ê¸°ë°˜ìœ¼ë¡œë„ í‚¤ì›Œë“œ ìƒì„±
            apiConnBadge.className = 'badge bg-success';
            apiConnBadge.textContent = 'ê²€ìƒ‰ ì™„ë£Œ';
        } catch (error) {
            console.error('ê²€ìƒ‰ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            apiStatusP.innerHTML =
                'âš ï¸ ê²€ìƒ‰ API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>API í‚¤/ì¿¼í„°/ë¦¬í¼ëŸ¬(ë„ë©”ì¸) ì œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.';
            apiConnBadge.className = 'badge bg-danger';
            apiConnBadge.textContent = 'ê²€ìƒ‰ ì˜¤ë¥˜';
            updateTrendKeywords([]);
        }
    }

    // ì±„ë„ êµ¬ë…ì ìˆ˜
    async function fetchChannelStats(videoItems) {
        const channelIds = Array.from(
            new Set(
                videoItems
                    .map(v => v.snippet.channelId)
                    .filter(Boolean)
            )
        );

        if (channelIds.length === 0) return {};

        const url = `${BASE_URL}channels?part=statistics&id=${channelIds.join(',')}&key=${API_KEY}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            const map = {};
            if (data.items) {
                data.items.forEach(ch => {
                    const id = ch.id;
                    const subs = ch.statistics.subscriberCount
                        ? parseInt(ch.statistics.subscriberCount)
                        : 0;
                    map[id] = subs;
                });
            }
            return map;
        } catch (e) {
            console.error('ì±„ë„ ì •ë³´ í˜¸ì¶œ ì˜¤ë¥˜:', e);
            return {};
        }
    }

    // êµ¬ë…ì ìˆ˜ê°€ íŠ¹ì • êµ¬ê°„ì— í•´ë‹¹í•˜ëŠ”ì§€ ì²´í¬
    function matchSubscriberRange(subscribers, rangeKey) {
        // ìˆ¨ê¹€ ì±„ë„(0ëª…)ì€ ì–´ë–¤ êµ¬ê°„ì—ë„ ë„£ì§€ ì•ŠìŒ
        if (!subscribers || subscribers <= 0) return false;

        switch (rangeKey) {
            case 'sub_1_1000':
                // 1 ~ 999
                return subscribers >= 1 && subscribers < 1000;
            case 'sub_1000_10000':
                // 1,000 ~ 9,999
                return subscribers >= 1000 && subscribers < 10000;
            case 'sub_10000_40000':
                // 10,000 ~ 39,999
                return subscribers >= 10000 && subscribers < 40000;
            case 'sub_50000_plus':
                // 50,000 ì´ìƒ
                return subscribers >= 50000;
            default:
                return true;
        }
    }

    // ê¸¸ì´ + ì •ë ¬ + êµ¬ë…ì í•„í„° ì ìš©í•œ ë¦¬ìŠ¤íŠ¸
    function getFilteredVideos() {
        let list = currentBaseVideos.slice();

        // 1) ê¸¸ì´ í•„í„°
        if (currentDurationFilter !== 'all') {
            list = list.filter(v => {
                const seconds = parseDurationSeconds(v.contentDetails?.duration || '');
                if (currentDurationFilter === 'short') return seconds > 0 && seconds <= 60;
                if (currentDurationFilter === 'long')  return seconds > 60;
                return true;
            });
        }

        // 2) êµ¬ë…ì í•„í„°
        //   'ì „ì²´'ë§Œ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ í•„í„° ì ìš© X
        if (!(currentSubscriberRanges.size === 1 && currentSubscriberRanges.has('all'))) {
            list = list.filter(v => {
                const channelId = v.snippet.channelId;
                const subs = currentChannelStatsMap[channelId] || 0;

                // ì„ íƒëœ êµ¬ê°„ ì¤‘ í•˜ë‚˜ë¼ë„ trueë©´ í†µê³¼
                for (const rangeKey of currentSubscriberRanges) {
                    if (matchSubscriberRange(subs, rangeKey)) {
                        return true;
                    }
                }
                return false;
            });
        }

        // 3) ì¡°íšŒìˆ˜ ì •ë ¬
        list.sort((a, b) => {
            const va = parseInt(a.statistics?.viewCount || '0', 10);
            const vb = parseInt(b.statistics?.viewCount || '0', 10);
            if (currentSortMode === 'viewsAsc') {
                return va - vb; // ì˜¤ë¦„ì°¨ìˆœ
            } else {
                return vb - va; // ë‚´ë¦¼ì°¨ìˆœ
            }
        });

        return list;
    }

    function updateVideoListAndStatus() {
        const apiStatusP = document.getElementById('api-status');
        const list = getFilteredVideos();
        renderVideoList(list, currentChannelStatsMap);

        if (!apiStatusP) return;
        if (currentSearchKeyword) {
            apiStatusP.textContent = `"${currentSearchKeyword}" ê²€ìƒ‰ ê²°ê³¼: ${list.length}ê°œ`;
        } else {
            apiStatusP.textContent = `ì´ ${list.length}ê°œì˜ ì˜ìƒì„ í‘œì‹œí•©ë‹ˆë‹¤.`;
        }
    }

    // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderVideoList(videos, channelStatsMap = {}) {
        const videoListDiv = document.getElementById('video-list');
        videoListDiv.innerHTML = '';

        videos.forEach(video => {
            const cardHtml = createVideoCard(video, channelStatsMap);
            videoListDiv.innerHTML += cardHtml;
        });
    }

    // ì¹´ë“œ í•˜ë‚˜
    function createVideoCard(video, channelStatsMap) {
        const title = video.snippet.title;
        const channelTitle = video.snippet.channelTitle;
        const channelId = video.snippet.channelId;
        const videoId = video.id;
        const thumbnailUrl = video.snippet.thumbnails.medium.url;
        const viewCount = video.statistics.viewCount ? parseInt(video.statistics.viewCount) : 0;
        const likeCount = video.statistics.likeCount ? parseInt(video.statistics.likeCount) : 0;
        const commentCount = video.statistics.commentCount ? parseInt(video.statistics.commentCount) : 0;
        const subscriberCount = channelStatsMap[channelId] || 0;
        const publishedAt = video.snippet.publishedAt;
        const timeAgoText = timeAgo(publishedAt);

        return `
            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                <div class="video-card">
                    <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank">
                        <img src="${thumbnailUrl}" class="card-img-top" alt="${title}">
                    </a>
                    <div class="card-body">
                        <h5 class="card-title">${title}</h5>
                        <p class="card-text text-muted mb-1">${channelTitle}</p>
                        <p class="card-text">
                            <span class="badge badge-time">${timeAgoText}</span>
                        </p>
                        <div>
                            <span class="stats-badge badge-views">${formatNumber(viewCount)} ì¡°íšŒ</span>
                            <span class="stats-badge badge-likes">${formatNumber(likeCount)} ì¢‹ì•„ìš”</span>
                            <span class="stats-badge badge-comments">${formatNumber(commentCount)} ëŒ“ê¸€</span>
                            <span class="stats-badge badge-subscribers">${formatNumber(subscriberCount)} êµ¬ë…</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /* =========================
       íŠ¸ë Œë“œ í‚¤ì›Œë“œ ê´€ë ¨ ë¡œì§
       ========================= */

    // í…ìŠ¤íŠ¸ â†’ í† í° ë°°ì—´
    function tokenizeText(text) {
        if (!text) return [];
        const tokens = text
            .toLowerCase()
            .split(/[^0-9a-zA-Zê°€-í£ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯]+/g)
            .filter(Boolean);
        return tokens;
    }

    function isStopword(token) {
        if (!token) return true;
        if (STOPWORDS_COMMON.has(token)) return true;
        if (STOPWORDS_KO.has(token)) return true;
        if (STOPWORDS_EN.has(token)) return true;
        if (STOPWORDS_JA.has(token)) return true;
        return false;
    }

    function isValidToken(token) {
        if (!token) return false;
        if (token.length < 2) return false;
        if (/^\d+$/.test(token)) return false;
        if (isStopword(token)) return false;
        return true;
    }

    // í˜„ì¬ ì˜ìƒë“¤ì—ì„œ íŠ¸ë Œë“œ í‚¤ì›Œë“œ ë¹Œë“œ
    function buildTrendKeywordsFromVideos(videos) {
        const wordScoreMap = new Map();

        videos.forEach(video => {
            const title = video.snippet.title || '';
            const tags = video.snippet.tags || [];
            const desc = video.snippet.description || '';
            const views = parseInt(video.statistics?.viewCount || '0', 10);

            // ì¡°íšŒìˆ˜ ê°€ì¤‘ì¹˜
            const weight = views > 0 ? Math.log10(views + 1) : 1;

            let text = title + ' ' + tags.join(' ') + ' ';
            // ì„¤ëª…ê¹Œì§€ ë„£ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
            // text += ' ' + desc;

            const tokens = tokenizeText(text);
            const tokenSet = new Set(tokens); // ê°™ì€ ì˜ìƒ ì•ˆì—ì„œëŠ” ì¤‘ë³µ ì œê±°

            tokenSet.forEach(tok => {
                if (!isValidToken(tok)) return;
                const prev = wordScoreMap.get(tok) || 0;
                wordScoreMap.set(tok, prev + weight);
            });
        });

        const entries = Array.from(wordScoreMap.entries())
            .map(([word, score]) => ({ word, score }))
            .sort((a, b) => b.score - a.score);

        return entries.slice(0, 30);
    }

    function updateTrendRegionInfo() {
        const { regionCode } = getRegionAndLanguage();
        const infoEl = document.getElementById('trend-region-info');
        if (infoEl) {
            infoEl.textContent = `ì§€ì—­: ${regionCode} ê¸°ì¤€`;
        }
    }

    function updateTrendUpdatedTime() {
        const el = document.getElementById('trend-updated-time');
        if (!el) return;
        const now = new Date();
        el.textContent = `ê¸°ì¤€: í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ì¸ê¸° ì˜ìƒ(ìµœê·¼ 48ì‹œê°„ ê¸°ì¤€)ì—ì„œ ìë™ ì¶”ì¶œ Â· ì—…ë°ì´íŠ¸ ${now.toLocaleTimeString()}`;
    }

    function updateTrendKeywords(keywordEntries) {
        currentTrendKeywords = keywordEntries || [];
        const listEl = document.getElementById('trend-keyword-list');
        if (!listEl) return;

        listEl.innerHTML = '';

        if (!currentTrendKeywords.length) {
            listEl.innerHTML = '<li><span class="trend-keyword">íŠ¸ë Œë“œ í‚¤ì›Œë“œë¥¼ ê³„ì‚°í•  ì˜ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span></li>';
            return;
        }

        currentTrendKeywords.forEach((item, idx) => {
            const li = document.createElement('li');

            const spanKeyword = document.createElement('span');
            spanKeyword.className = 'trend-keyword';
            spanKeyword.textContent = `${idx + 1}. ${item.word}`;

            const spanScore = document.createElement('span');
            spanScore.className = 'trend-score-badge';
            spanScore.textContent = `score ${item.score.toFixed(1)}`;

            li.appendChild(spanKeyword);
            li.appendChild(spanScore);
            listEl.appendChild(li);
        });

        updateTrendUpdatedTime();
    }

    function buildAndRenderTrendKeywords() {
        if (!currentBaseVideos || currentBaseVideos.length === 0) {
            updateTrendKeywords([]);
            return;
        }
        const entries = buildTrendKeywordsFromVideos(currentBaseVideos);
        updateTrendKeywords(entries);
    }

    /* =========================
       ì´ë²¤íŠ¸ ë°”ì¸ë”© ë° ì´ˆê¸°í™”
       ========================= */

    // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼
    document.querySelectorAll('.category-button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelector('.category-button.active')?.classList.remove('active');
            this.classList.add('active');

            currentCategory = this.getAttribute('data-category');
            const categoryId = CATEGORIES[currentCategory];

            document.getElementById('category-title').textContent = this.textContent.trim();
            const input = document.getElementById('searchInput');
            input.value = '';
            currentSearchKeyword = '';
            fetchPopularVideos(categoryId);
        });
    });

    // ì–¸ì–´ ì²´í¬ë°•ìŠ¤
    ['langKR', 'langEN', 'langJP'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
            const categoryId = CATEGORIES[currentCategory];
            const keyword = document.getElementById('searchInput').value.trim();
            if (keyword) {
                searchVideosByKeyword(keyword);
            } else {
                fetchPopularVideos(categoryId);
            }
        });
    });

    // ê¸¸ì´ í•„í„° ë²„íŠ¼
    document.querySelectorAll('.duration-button').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelector('.duration-button.active')?.classList.remove('active');
            this.classList.add('active');
            currentDurationFilter = this.getAttribute('data-duration');
            updateVideoListAndStatus();
        });
    });

    // ì •ë ¬ ë²„íŠ¼
    document.querySelectorAll('.sort-button').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelector('.sort-button.active')?.classList.remove('active');
            this.classList.add('active');
            currentSortMode = this.getAttribute('data-sort'); // viewsDesc | viewsAsc
            updateVideoListAndStatus();
        });
    });

    // êµ¬ë…ì í•„í„° ì²´í¬ë°•ìŠ¤
    document.querySelectorAll('.subscriber-filter-checkbox').forEach(cb => {
        cb.addEventListener('change', function () {
            const range = this.getAttribute('data-range');

            if (range === 'all') {
                // "ì „ì²´" í´ë¦­ ì‹œ
                if (this.checked) {
                    currentSubscriberRanges = new Set(['all']);
                    document.querySelectorAll('.subscriber-filter-checkbox').forEach(other => {
                        if (other !== this) other.checked = false;
                    });
                } else {
                    // ì „ì²´ë¥¼ í•´ì œí•˜ë©´ ì•„ë¬´ êµ¬ê°„ë„ ì—†ëŠ” ìƒíƒœê°€ ë˜ë¯€ë¡œ ë‹¤ì‹œ ì¼œê¸°
                    this.checked = true;
                    currentSubscriberRanges = new Set(['all']);
                }
            } else {
                if (this.checked) {
                    // ê°œë³„ êµ¬ê°„ ì²´í¬ â†’ ì „ì²´ í•´ì œ
                    currentSubscriberRanges.delete('all');
                    const allCb = document.getElementById('subFilterAll');
                    if (allCb) allCb.checked = false;

                    currentSubscriberRanges.add(range);
                } else {
                    currentSubscriberRanges.delete(range);

                    // ì•„ë¬´ êµ¬ê°„ë„ ì•ˆ ë‚¨ìœ¼ë©´ ìë™ìœ¼ë¡œ ì „ì²´ ë³µê·€
                    if (currentSubscriberRanges.size === 0) {
                        currentSubscriberRanges.add('all');
                        const allCb = document.getElementById('subFilterAll');
                        if (allCb) allCb.checked = true;
                    }
                }
            }

            updateVideoListAndStatus();
        });
    });

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
    document.getElementById('searchBtn').addEventListener('click', () => {
        const keyword = document.getElementById('searchInput').value.trim();
        const categoryId = CATEGORIES[currentCategory];

        if (!keyword) {
            currentSearchKeyword = '';
            fetchPopularVideos(categoryId);
        } else {
            searchVideosByKeyword(keyword);
        }
    });

    // Enterë¡œ ê²€ìƒ‰
    document.getElementById('searchInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('searchBtn').click();
        }
    });

    // ì´ˆê¸° ì„¤ì •
    document.addEventListener('DOMContentLoaded', () => {
        loadApiKey();

        const saveBtn = document.getElementById('saveApiKeyBtn');
        const clearBtn = document.getElementById('clearApiKeyBtn');
        if (saveBtn) saveBtn.addEventListener('click', saveApiKey);
        if (clearBtn) clearBtn.addEventListener('click', clearApiKey);

        updateTrendRegionInfo();
        fetchPopularVideos(CATEGORIES[currentCategory]);

        // 30ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(() => {
            const categoryId = CATEGORIES[currentCategory];
            if (currentSearchKeyword) {
                searchVideosByKeyword(currentSearchKeyword);
            } else {
                fetchPopularVideos(categoryId);
            }
        }, 30 * 60 * 1000); // 30ë¶„
    });
</script>

</body>
</html>
